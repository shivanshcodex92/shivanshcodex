<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shivanshcodex</title>

<!-- ===== STYLE ===== -->
<style>
*{box-sizing:border-box;font-family:system-ui,-apple-system}
body{
  margin:0;height:100vh;
  background:linear-gradient(135deg,#0b141a,#111b21,#202c33);
  color:#fff;
}
.hidden{display:none}

/* TOP BAR */
.topbar{
  height:60px;
  background:#202c33;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 15px;
}
.topbar h1{margin:0;font-size:20px}
.topbar span{font-size:12px;opacity:.7}
.topbar button{
  background:#25d366;border:none;
  padding:10px 16px;
  border-radius:20px;font-weight:bold;
}

/* LOGIN */
.card{
  margin:20px;
  background:#202c33;
  padding:20px;
  border-radius:12px;
}
input{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
}
.row{display:flex;gap:10px}
button{
  background:#25d366;
  border:none;
  padding:12px;
  border-radius:20px;
  font-weight:bold;
  cursor:pointer;
}
button:active{transform:scale(.95)}

/* CHAT */
.chat-app{
  display:flex;
  height:calc(100vh - 60px);
}
.sidebar{
  width:35%;
  background:#111b21;
  padding:10px;
  overflow-y:auto;
}
.chat-list li{
  list-style:none;
  padding:12px;
  background:#202c33;
  border-radius:10px;
  margin-bottom:8px;
}
.chat-screen{
  width:65%;
  display:flex;
  flex-direction:column;
  background:#0b141a;
}
.chat-header{
  background:#202c33;
  padding:12px;
  font-weight:bold;
}
.messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:75%;
  padding:10px 14px;
  border-radius:12px;
  margin-bottom:6px;
}
.me{align-self:flex-end;background:#25d366;color:#000}
.other{align-self:flex-start;background:#202c33}
.send-box{
  display:flex;
  gap:6px;
  padding:10px;
  background:#202c33;
}
.send-box input{flex:1;border-radius:20px}

/* MOBILE */
@media(max-width:768px){
  .sidebar{width:40%}
  .chat-screen{width:60%}
}
</style>
</head>

<body>

<!-- TOP -->
<div class="topbar">
  <div>
    <h1>Shivanshcodex</h1>
    <span>WhatsApp-like chat</span>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2>Login</h2>
  <input id="email" placeholder="email@example.com">
  <input id="password" type="password" placeholder="password">
  <input id="username" placeholder="username">
  <div class="row">
    <button onclick="login()">Login</button>
    <button onclick="register()">Create account</button>
  </div>
  <p style="opacity:.7">Tip: 2 browsers / incognito me 2 users bana ke test karo</p>
</div>

<!-- CHAT -->
<div id="chatApp" class="chat-app hidden">
  <aside class="sidebar">
    <div class="row">
      <input id="searchUser" placeholder="Add user">
      <button onclick="startChat()">+</button>
    </div>
    <ul id="chatList" class="chat-list"></ul>
  </aside>

  <section class="chat-screen">
    <div id="chatHeader" class="chat-header">Select a chat</div>
    <div id="messages" class="messages"></div>
    <div class="send-box">
      <input id="msgInput" placeholder="Message">
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </section>
</div>

<!-- ===== FIREBASE ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,collection,addDoc,onSnapshot,query,where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDS6wdYNG2Q7ZUNPjUXdOn-Sqb3cLC4NgQ",
  authDomain:"shivanshcodex-5fa03.firebaseapp.com",
  projectId:"shivanshcodex-5fa03",
  storageBucket:"shivanshcodex-5fa03.firebasestorage.app",
  messagingSenderId:"160989825267",
  appId:"1:160989825267:web:891e3ac888a46df3920f86"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth();
const db=getFirestore();

let currentUser=null;
let currentChat=null;

/* AUTH */
window.register=async()=>{
  const e=email.value,p=password.value,u=username.value;
  const res=await createUserWithEmailAndPassword(auth,e,p);
  await setDoc(doc(db,"users",res.user.uid),{username:u});
};

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.logout=()=>signOut(auth);

/* STATE */
onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUser=user;
    loginCard.classList.add("hidden");
    chatApp.classList.remove("hidden");
  }else{
    loginCard.classList.remove("hidden");
    chatApp.classList.add("hidden");
  }
});

/* CHAT */
window.startChat=async()=>{
  const uname=searchUser.value;
  const q=query(collection(db,"users"),where("username","==",uname));
  onSnapshot(q,s=>{
    s.forEach(d=>{
      currentChat=[currentUser.uid,d.id].sort().join("_");
      chatHeader.innerText=uname;
      listenMessages();
    })
  })
}

function listenMessages(){
  messages.innerHTML="";
  onSnapshot(collection(db,"chats",currentChat,"messages"),snap=>{
    snap.forEach(m=>{
      const d=m.data();
      const div=document.createElement("div");
      div.className="msg "+(d.uid===currentUser.uid?"me":"other");
      div.innerText=d.text;
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    })
  })
}

window.sendMessage=async()=>{
  if(!currentChat)return;
  await addDoc(collection(db,"chats",currentChat,"messages"),{
    text:msgInput.value,
    uid:currentUser.uid,
    ts:Date.now()
  });
  msgInput.value="";
}
</script>

</body>
</html>
